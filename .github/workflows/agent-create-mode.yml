name: Agent - Create Game Mode

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: 'Game mode description prompt'
        required: true
        type: string
      request_id:
        description: 'Unique request identifier'
        required: true
        type: string

concurrency:
  group: agent-create
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  create-mode:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'web/package-lock.json'

      - name: Install dependencies
        run: cd web && npm ci

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      # Stage 1: Game Design (GDD)
      # Agent: game-design-orchestrator → classic-rule-agent + creative-rule-agent
      - name: "Stage 1: Game Design (GDD)"
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          claude -p "$(cat <<'PROMPT_EOF'
          REQUEST: ${{ github.event.inputs.prompt }}

          ## Instructions
          Read web/.claude/agents/game-design-orchestrator.md for the full process.
          In CI you cannot spawn sub-agents, so play BOTH roles yourself:
          1. Propose from Classic perspective (read web/.claude/agents/classic-rule-agent.md)
          2. Propose from Creative perspective (read web/.claude/agents/creative-rule-agent.md)
          3. Resolve conflicts and produce a unified GDD

          ## Keyword
          Extract a kebab-case keyword from the request.
          Use this keyword for all output paths.

          ## Constraints
          Read web/.claude/skills/game-mode-constraint/SKILL.md — design must respect all constraints.

          ## Output
          Write unified GDD to web/docs/gdd/{keyword}/gdd.md
          PROMPT_EOF
          )" --allowedTools "Read,Write,Edit,Glob,Grep,Bash" --max-turns 20

      # Stage 2: Documentation (PRD & TRD)
      # Agent: doc-agent → generate-prd skill + generate-trd skill
      - name: "Stage 2: Documentation (PRD & TRD)"
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          claude -p "$(cat <<'PROMPT_EOF'
          Read web/.claude/agents/doc-agent.md for the full process.

          ## Task
          1. Find the GDD: look in web/docs/gdd/ for the most recently created directory
          2. Read ALL GDD files in that directory
          3. Generate PRD following web/.claude/skills/generate-prd/SKILL.md and its references/prd-template.md
          4. Generate TRD following web/.claude/skills/generate-trd/SKILL.md and its references/trd-template.md
          5. Write to web/docs/prd/{keyword}/prd.md and web/docs/trd/{keyword}/trd.md
          PROMPT_EOF
          )" --allowedTools "Read,Write,Edit,Glob,Grep,Bash" --max-turns 20

      # Stage 3: Constraint Review + Implementation
      # Agent: game-mode-creator → game-mode-constraint skill + classic-rule-agent
      - name: "Stage 3: Constraint Review & Implementation"
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          claude -p "$(cat <<'PROMPT_EOF'
          REQUEST_ID: ${{ github.event.inputs.request_id }}

          Read web/.claude/agents/game-mode-creator.md and follow the full workflow.

          In CI you cannot spawn sub-agents. For Phase 2 (constraint review loop),
          read web/.claude/agents/classic-rule-agent.md and apply that perspective yourself
          when fixing constraint violations.

          ## Task
          1. Find the keyword: look in web/docs/gdd/ for the most recently created directory
          2. Follow game-mode-creator phases: constraint load → review loop → implement → build verify
          PROMPT_EOF
          )" --allowedTools "Read,Write,Edit,Glob,Grep,Bash" --max-turns 50

      - name: Build verification
        run: cd web && npm run build

      - name: Commit and push
        run: |
          git config user.name "claude-agent[bot]"
          git config user.email "claude-agent[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git commit -m "feat: add new game mode via agent

          Request: ${{ github.event.inputs.prompt }}
          Request ID: ${{ github.event.inputs.request_id }}

          Co-Authored-By: Claude <noreply@anthropic.com>"
          git push

      - name: Deploy to Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          npm install -g vercel
          cd web
          DEPLOY_URL=$(vercel --prod --public -y --token "$VERCEL_TOKEN" 2>&1 | grep -oP 'https://\S+\.vercel\.app' | tail -1)
          vercel alias set "$DEPLOY_URL" solitaire-hunter.vercel.app --token "$VERCEL_TOKEN"
          echo "Deployed: https://solitaire-hunter.vercel.app"
