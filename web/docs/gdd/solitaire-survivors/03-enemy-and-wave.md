# Enemy & Wave System - 적 및 웨이브 시스템

## 개요

Solitaire Survivors 모드는 10분 동안 10개의 웨이브를 진행하며, 플레이어는 중앙에 고정된 채 사방에서 스폰되는 적을 막아야 한다. 적 타입, 약점 시스템, 스폰 패턴이 점진적으로 복잡해지며 레벨업과 스코어링이 결합되어 몰입감을 제공한다.

## 적 스폰 메커니즘

### 스폰 위치
```
┌─────────────────────────┐
│  ↓   ↓   ↓   ↓   ↓   ↓  │ 상단 가장자리
│←                      ← │ 좌우 가장자리
│        [PLAYER]         │ 중앙 고정
│→                      → │
│  ↑   ↑   ↑   ↑   ↑   ↑  │ 하단 가장자리
└─────────────────────────┘
```

- 적은 **상단 게임뷰의 사방 가장자리**에서 무작위 위치에 스폰
- 스폰 위치는 가장자리 전체 길이에서 균등 분포
- 북/남/동/서 방향이 균등하게 선택됨 (각 25% 확률)

### 이동 패턴
- 모든 적은 **플레이어 캐릭터(중앙 고정)를 향해 직진**
- 경로 재계산 없음 (스폰 시점 방향으로 직선 이동)
- 적이 캐릭터에 **접촉 시 피해** 적용
- 피해 적용 후 적은 **넉백**되어 다시 접근 (사망하지 않음)

### 스폰 간격 (웨이브별)
| 웨이브 | 스폰 간격 | 동시 출현 적 수 (예상) |
|--------|----------|---------------------|
| 1 | 2.0초 | 30마리 (60초 ÷ 2.0초) |
| 2 | 1.8초 | 33마리 |
| 3 | 1.5초 | 40마리 |
| 4 | 1.3초 | 46마리 |
| 5 | 1.1초 | 54마리 |
| 6 | 1.0초 | 60마리 |
| 7 | 0.8초 | 75마리 |
| 8 | 0.6초 | 100마리 |
| 9 | 0.4초 | 150마리 |
| 10 | 0.3초 | 200마리 |

**스폰 공식**: `interval = 2.0 - (wave - 1) * 0.189` (대략)

## 적 타입

기존 디펜스 모드의 적 타입을 재사용하되, 실시간 전투에 맞게 행동 패턴을 조정한다.

### 기본 적 타입

| 타입 | 설명 | 기본 HP | 이동속도 | 공격력 | 특수 능력 | 등장 웨이브 |
|------|------|---------|---------|--------|-----------|------------|
| **Grunt** | 가장 기본적인 적 | 40 | 1.0 (60px/s) | 8 | 없음 | Wave 1+ |
| **Runner** | 빠르게 돌진하는 적 | 25 | 2.0 (120px/s) | 5 | 빠른 이동 | Wave 2+ |
| **Shield** | 전방 방어 보유 | 60 | 0.7 (42px/s) | 6 | 전방 피해 50% 감소 | Wave 3+ |
| **Ranger** | 원거리 투사체 발사 | 35 | 0.9 (54px/s) | 10 | 200px 거리에서 투사체 발사 (2초 쿨다운) | Wave 4+ |
| **Healer** | 주변 적 회복 | 35 | 0.8 (48px/s) | 3 | 100px 반경 내 적 초당 10 HP 회복 | Wave 6+ |
| **Siege** | 대형 고체력 적 | 120 | 0.5 (30px/s) | 15 | 높은 HP와 접촉 피해 | Wave 8+ |

### 엘리트 및 보스 적

| 타입 | 출현 | HP | 이동속도 | 공격력 | 특수 능력 |
|------|------|-----|---------|--------|-----------|
| **미니보스: Brute** | Wave 4 | 200 (기본 HP x5) | 0.8 | 20 | 접촉 시 플레이어 넉백 (2칸, 0.5초 기절) |
| **미니보스: Shadow** | Wave 7 | 150 (기본 HP x5) | 1.5 | 25 | 3초마다 0.5초 투명화 (피격 무효) |
| **최종 보스: King of Ruin** | Wave 10 | 800 (기본 HP x20) | 0.6 | 30 | 3페이즈 전투 (아래 참조) |

## Suit 약점 시스템

### 개별 적 약점 표시

```
   ♠ (약점)
  [GRUNT]
```

- 모든 적은 **개별적으로 무작위 Suit 약점**을 가짐 (Spade/Heart/Diamond/Club 중 1개)
- 적 머리 위에 **약점 Suit 아이콘**이 명확히 표시됨
- 약점 Suit는 스폰 시 결정되며 변경되지 않음

### 약점 데미지 보너스
| 상황 | 데미지 배율 |
|------|----------|
| **약점 Suit 투사체 적중** | **x2.0** |
| 비약점 Suit 투사체 적중 | x1.0 (기본) |

**설계 원칙**:
- 약점 미적중도 기본 데미지로 처리 (처벌 없음)
- 약점 적중은 순수 **보너스 보상**
- 플레이어가 약점을 무시하고도 게임 진행 가능

### 보스 Suit 내성 (보스만 적용)

**미니보스(Brute, Shadow)**: Suit 내성 없음 (약점만 존재)

**최종 보스(King of Ruin)**: 4 Suit 내성 시스템
- 3개 Suit은 **내성**(비약점), 1개 Suit은 **약점**
- 내성 Suit 투사체: **데미지 x0.5**
- 약점 Suit 투사체: **데미지 x2.0**
- 약점 Suit는 **30초마다 순환** (Spade → Heart → Diamond → Club 순서)
- 순환 5초 전부터 화면에 "약점 변경 예고" 표시

```
King of Ruin 약점 순환 타임라인
0-30초:  약점 Spade  (Heart/Diamond/Club 내성)
30-60초: 약점 Heart  (Spade/Diamond/Club 내성)
60-90초: 약점 Diamond (Spade/Heart/Club 내성)
90초~:   약점 Club   (Spade/Heart/Diamond 내성)
```

## 웨이브 구조

### 10분 10웨이브 타임라인

| 웨이브 | 시간 | 적 구성 | 스폰 간격 | HP 배율 | 특수 이벤트 |
|--------|------|---------|----------|---------|-----------|
| **1** | 0-1분 | Grunt | 2.0초 | x1.0 | 튜토리얼 텍스트 표시 |
| **2** | 1-2분 | Grunt + Runner | 1.8초 | x1.1 | Runner 첫 등장 |
| **3** | 2-3분 | Grunt + Runner + Shield | 1.5초 | x1.3 | **레벨업 선택지 1회** |
| **4** | 3-4분 | 혼합 + Ranger | 1.3초 | x1.5 | **미니보스: Brute** |
| **5** | 4-5분 | 혼합 (4종) | 1.1초 | x1.8 | 약점 다양화 (전략 중요도 증가) |
| **6** | 5-6분 | 혼합 + Healer | 1.0초 | x2.0 | **레벨업 선택지 1회** |
| **7** | 6-7분 | 혼합 (5종) | 0.8초 | x2.3 | **미니보스: Shadow** |
| **8** | 7-8분 | 혼합 + Siege | 0.6초 | x2.8 | 엘리트 다수 (Brute + Shadow 재등장) |
| **9** | 8-9분 | 혼합 (6종) | 0.4초 | x3.5 | **레벨업 선택지 1회** |
| **10** | 9-10분 | 전체 타입 혼합 | 0.3초 | x4.0 | **최종 보스: King of Ruin** |

### 웨이브별 상세

#### Wave 1 (튜토리얼)
- Grunt만 등장
- 화면 중앙에 간단한 조작 안내:
  - "솔리테어 카드를 Foundation에 올려 투사체를 강화하세요"
  - "적의 약점 Suit 투사체로 2배 데미지!"
- 적 밀도 낮음, 여유 있는 학습 시간

#### Wave 2-3 (기초 확립)
- Runner(빠름), Shield(전방 방어) 추가
- Wave 3 종료 시 **첫 레벨업 선택지**
- 플레이어가 투사체-약점 시스템 숙달

#### Wave 4 (첫 도전)
- Ranger(원거리 공격) 추가로 다방향 위협
- **미니보스 Brute** 등장 (HP x5, 처치 시 **확정 야생카드 1장** 드랍)
- 미니보스는 웨이브 중반(30초 시점)에 화면 상단 중앙에서 스폰

#### Wave 5-6 (중반 압박)
- Healer 추가로 적 생존력 증가 → Healer 우선 처치 필요
- 약점 다양화로 전략적 투사체 선택 중요도 증가
- Wave 6 종료 시 **두 번째 레벨업 선택지**

#### Wave 7-8 (후반 고난도)
- Wave 7: **미니보스 Shadow** (투명화 회피 패턴)
- Wave 8: Siege 추가 + 엘리트 다수 (Brute + Shadow 동시 등장)
- 스폰 간격 0.6초로 화면에 20+ 적 동시 존재

#### Wave 9 (최후의 시험)
- 최대 적 밀도 (스폰 간격 0.4초)
- Wave 9 종료 시 **세 번째 레벨업 선택지** (최종 강화 기회)
- 플레이어가 레벨업으로 최종 빌드 완성

#### Wave 10 (최종 보스)
- **King of Ruin** 등장
- 일반 적도 계속 스폰 (간격 0.3초, 밀도 유지)
- 보스 처치 시 게임 승리

### 최종 보스: King of Ruin

#### 기본 스펙
- **HP**: 800 (일반 적 대비 x20)
- **이동속도**: 0.6 (느림, 압박감 유지하며 천천히 접근)
- **공격력**: 30 (접촉 시 HP 30 피해)
- **크기**: 일반 적 대비 2.5배

#### 4 Suit 내성 시스템
- 3개 Suit: 데미지 x0.5 (내성)
- 1개 Suit: 데미지 x2.0 (약점)
- **약점 순환**: 30초마다 Spade → Heart → Diamond → Club 순서로 변경
- 순환 5초 전 화면 중앙 상단에 "약점 변경 예고" 표시

#### 3 페이즈 전투

**Phase 1 (HP 800-534)**
- 기본 이동 + 접촉 공격
- 매 10초마다 **범위 공격** (150px 반경, 15 피해)
- 플레이어가 약점 Suit 투사체 전환 숙달 필요

**Phase 2 (HP 533-267)**
- 이동속도 **1.5배 증가** (0.6 → 0.9)
- 매 8초마다 **Shield 적 2마리 소환** (보스 주변에서 스폰)
- 범위 공격 쿨다운 8초로 단축

**Phase 3 (HP 266-0)**
- 이동속도 **2.0배 증가** (0.6 → 1.2)
- **모든 화면상 적의 이동속도 +50%**
- 매 5초마다 **전체 화면 펄스 공격** (10 피해, 회피 불가)
- 약점 순환 속도 20초로 단축

#### 처치 보상
- **스코어 +500점**
- 게임 승리 (10분 생존 완료)
- 최종 스코어 집계 화면 전환

## 미니보스 메커니즘

### 미니보스 공통 특성
- HP가 일반 적 대비 **x5**
- 처치 시 **확정 야생카드 1장** 드랍 (Joker/Peek/Bomb 중 무작위)
- 웨이브 중반(30초 시점)에 등장
- 스폰 위치: 화면 상단 중앙 (돌출 연출)
- 미니보스 등장 시 화면 하단에 "WARNING: BOSS APPROACHING" 텍스트 3초간 표시

### Brute (Wave 4)
- HP: 200
- 특수 능력: 접촉 시 플레이어 **넉백** (2칸 거리, 0.5초 기절)
- 기절 중 무적 아님 (데미지는 받음)
- 전술적 대응: 거리 유지, 약점 Suit 집중 공격

### Shadow (Wave 7)
- HP: 150
- 특수 능력: 3초마다 0.5초 **투명화** (피격 무효)
- 투명화 중 반투명 실루엣으로 위치만 표시
- 전술적 대응: 투명화 타이밍 파악, 투사체 발사 시점 조절

## 레벨업 시스템

### 경험치 소스

| 행동 | 경험치 | 비고 |
|------|--------|------|
| Grunt 처치 | 10 XP | |
| Runner 처치 | 8 XP | HP 낮지만 빠름 |
| Shield 처치 | 15 XP | |
| Ranger 처치 | 12 XP | |
| Healer 처치 | 18 XP | 우선 처치 보상 |
| Siege 처치 | 25 XP | |
| 미니보스 처치 | 100 XP | |
| **Tableau face-down 카드 뒤집기** | 5 XP | 솔리테어 보조 경험치 |

### 레벨업 타이밍
- 총 **3회** 레벨업 (Wave 3, 6, 9 종료 시)
- 레벨업 시 **게임 일시정지** (솔리테어도 정지, 적 이동 정지)
- 화면 중앙에 3개 선택지 표시 (카드 형태)
- 선택 제한시간 없음 (신중한 선택 가능)

### 레벨업 선택지 카테고리

#### 1. 투사체 강화 (Projectile Power)

| 선택지 | 효과 | 등장 레벨 |
|--------|------|----------|
| Spade 데미지 +20% | Spade 투사체 영구 데미지 증가 | 1, 2, 3 |
| Heart 데미지 +20% | Heart 투사체 영구 데미지 증가 | 1, 2, 3 |
| Diamond 데미지 +20% | Diamond 투사체 영구 데미지 증가 | 1, 2, 3 |
| Club 데미지 +20% | Club 투사체 영구 데미지 증가 | 1, 2, 3 |
| 발사속도 +15% | 모든 투사체 발사 간격 단축 | 2, 3 |
| 투사체 관통 +1 | 투사체가 적 1마리 추가 관통 | 2, 3 |
| 크리티컬 확률 +10% | 모든 투사체 크리티컬 확률 증가 (데미지 x1.5) | 3 |

#### 2. 생존 강화 (Survival)

| 선택지 | 효과 | 등장 레벨 |
|--------|------|----------|
| 최대 HP +20 | 최대 HP 영구 증가 + 즉시 회복 | 1, 2, 3 |
| 피격 후 무적 시간 +0.3초 | 피격 후 무적 0.5초 → 0.8초 | 1, 2 |
| 이동속도 +15% | (미구현 - 캐릭터 고정) 대신 **넉백 거리 +50%** | 2, 3 |
| HP 자동 재생 | 초당 HP 2 회복 (전투 중에도 지속) | 3 |
| 피격 시 Shield 생성 | 피격 시 5초간 Shield (데미지 50% 감소, 쿨다운 15초) | 3 |

#### 3. 솔리테어 보조 (Solitaire Aid)

| 선택지 | 효과 | 등장 레벨 |
|--------|------|----------|
| Stock 5장 드로우 | 즉시 Stock에서 5장 Waste로 이동 (1회성) | 1, 2, 3 |
| face-down 2장 Peek | 즉시 Tableau face-down 카드 2장 미리보기 (1회성) | 1, 2, 3 |
| 야생카드 드랍률 +5% | 적 처치 시 야생카드 드랍 확률 증가 | 2, 3 |
| Foundation 보너스 +20% | Foundation 카드 적재 시 투사체 강화 효과 증가 | 2, 3 |
| 콤보 타이머 +3초 | Suit 콤보 타이머 10초 → 13초 (여유 증가) | 3 |

### 선택지 풀 구성 (웨이브별)

**Wave 3 레벨업 (첫 번째)**
- 투사체 강화: Suit 데미지 +20% 4종 중 3개 제시
- 생존 강화: HP +20, 무적 시간 +0.3초
- 솔리테어 보조: Stock 5장, face-down Peek

**Wave 6 레벨업 (두 번째)**
- 투사체 강화: Suit 데미지 +20%, 발사속도 +15%, 관통 +1
- 생존 강화: HP +20, 넉백 +50%, 무적 시간 +0.3초
- 솔리테어 보조: 드랍률 +5%, Foundation 보너스 +20%

**Wave 9 레벨업 (세 번째, 최종)**
- 투사체 강화: 발사속도 +15%, 관통 +1, 크리티컬 +10%
- 생존 강화: HP 자동 재생, 피격 Shield, HP +20
- 솔리테어 보조: 콤보 타이머 +3초, 드랍률 +5%

## 스코어링 시스템

### 스코어 항목

| 항목 | 점수 | 최대 점수 | 비고 |
|------|------|----------|------|
| **생존 시간** | 초당 1점 | 600점 | 10분 완주 시 600점 |
| **일반 적 처치** | 적당 10점 | 변동 | 웨이브별 적 수에 따라 |
| **미니보스 처치** | 보스당 50점 | 100점 | Brute + Shadow |
| **최종 보스 처치** | 500점 | 500점 | King of Ruin |
| **Foundation 카드** | 카드당 20점 | 1040점 | 52장 전부 시 1040점 |
| **Suit 콤보** | 콤보당 25점 | 변동 | 연속 적재 콤보 |
| **듀얼 콤보 해금** | 콤보당 100점 | 300점 | Red/Black/Royal 각 1회 |
| **Full Suit 완성** | Suit당 200점 | 800점 | Spade/Heart/Diamond/Club 각 K까지 |
| **잔여 HP** | HP 1당 5점 | 500점 | 최대 HP 100 가정 |
| **솔리테어 완성** | 1000점 | 1000점 | 52장 전부 Foundation (Full Suit x4 별도 계산) |

### 등급 기준

| 등급 | 최소 점수 | 조건 |
|------|----------|------|
| **S** | 5000+ | 솔리테어 완성 + 높은 전투 퍼포먼스 |
| **A** | 3500+ | Full Suit 2개 이상 + 보스 처치 |
| **B** | 2000+ | Foundation 절반 이상 + 생존 |
| **C** | 1000+ | 기본 생존 + 일부 Foundation |
| **D** | ~999 | 조기 사망 또는 낮은 진행도 |

### 스코어 계산 예시

**S 등급 런 (5200점)**
```
생존 시간:     600점 (10분 완주)
적 처치:       800점 (일반 80마리)
보스 처치:     600점 (미니 2 + 최종)
Foundation:    1040점 (52장 전부)
Suit 콤보:     200점 (8회)
듀얼 콤보:     300점 (3종 전부)
Full Suit:     800점 (4 Suit 전부)
잔여 HP:       400점 (HP 80 잔여)
솔리테어 완성: 1000점
─────────────────────
합계:          5740점 (S 등급)
```

**A 등급 런 (3600점)**
```
생존 시간:     600점
적 처치:       600점
보스 처치:     600점
Foundation:    800점 (40장)
Suit 콤보:     150점
듀얼 콤보:     200점 (2종)
Full Suit:     400점 (2 Suit)
잔여 HP:       250점
─────────────────────
합계:          3600점 (A 등급)
```

## 웨이브 간 전이

### 상태 이월
웨이브 간 다음 요소가 **그대로 유지**된다:
- **플레이어 HP**: 이월 (웨이브 간 자동 회복 없음)
- **Tableau/Stock/Waste 상태**: 이전 웨이브에서 플레이한 상태 계속
- **Foundation**: 이미 올린 카드 유지 + 투사체 상태 유지
- **레벨업 강화**: 모든 선택한 강화 효과 영구 유지
- **야생카드 보유**: 사용하지 않은 야생카드 이월

### 웨이브 클리어 보상
- **face-down 카드 1장 자동 reveal** (Tableau에 face-down이 있을 경우)
- 3초간 "WAVE X CLEAR" 텍스트 표시
- 레벨업 웨이브(3, 6, 9)는 레벨업 선택 화면으로 자동 전환

### 솔리테어 완성 후
플레이어가 52장 전부 Foundation에 올리면:
1. **"Solitaire Complete! +1000"** 텍스트 표시
2. **새 덱 딜링** (선택사항, 확인 팝업)
3. 거부 시 투사체는 마지막 상태로 유지 (새 카드 없이 전투만 지속)

## 난이도 조절 요소

### 동적 난이도 완화 (선택적 구현)
플레이어가 연속으로 피격되거나 HP가 30% 이하일 경우:
- 적 스폰 간격 +10% (일시적)
- 야생카드 드랍률 +3%
- 피격 후 무적 시간 +0.2초

**설계 원칙**: 플레이어가 "벽에 부딪혔을 때" 돌파구 제공

### 난이도 선택 (v1 스코프 외)
향후 확장으로 Easy/Normal/Hard 난이도 추가 가능:
- Easy: 적 HP -30%, 스폰 간격 +50%
- Normal: 기본값
- Hard: 적 HP +50%, 스폰 간격 -30%, 약점 보너스 x1.5 (x2.0 대신)

## 디버깅 및 밸런싱 파라미터

개발 중 조정 가능한 주요 파라미터:

```typescript
// 적 스폰
const SPAWN_INTERVAL_BASE = 2.0;      // Wave 1 기본 간격
const SPAWN_INTERVAL_MIN = 0.3;       // Wave 10 최소 간격
const SPAWN_INTERVAL_DECAY = 0.189;   // 웨이브당 감소량

// 적 HP 스케일링
const HP_SCALE_BASE = 1.0;            // Wave 1
const HP_SCALE_GROWTH = 0.35;         // 웨이브당 증가
const HP_SCALE_MAX = 4.0;             // Wave 10

// 약점 데미지
const WEAKNESS_MULTIPLIER = 2.0;
const RESISTANCE_MULTIPLIER = 0.5;    // 보스만

// 미니보스
const MINIBOSS_HP_MULTIPLIER = 5.0;
const MINIBOSS_WILDCARD_DROP_RATE = 1.0;  // 100% 확정

// 최종 보스
const FINALBOSS_HP = 800;
const FINALBOSS_WEAKNESS_CYCLE = 30;  // 초
const FINALBOSS_PHASE2_THRESHOLD = 0.667;
const FINALBOSS_PHASE3_THRESHOLD = 0.333;
```

## 구현 우선순위

### Phase 1 (MVP)
1. 기본 적 스폰 시스템 (Grunt만, 고정 간격)
2. 약점 시스템 (아이콘 표시 + x2.0 데미지)
3. 웨이브 1-3 구현
4. 첫 레벨업 시스템 (3개 선택지, 간단한 효과)

### Phase 2 (확장)
5. 모든 적 타입 추가 (Runner, Shield, Ranger, Healer, Siege)
6. 미니보스 2종 (Brute, Shadow)
7. 웨이브 4-9 구현
8. 전체 레벨업 선택지 구현

### Phase 3 (완성)
9. 최종 보스 King of Ruin (3 페이즈)
10. 스코어링 시스템 + 등급 판정
11. 웨이브 클리어 보상 (face-down reveal)
12. 밸런싱 조정

---

## 참고 문서
- `01-core-loop.md`: 실시간 전투 + 솔리테어 동시 진행 루프
- `02-projectile-system.md`: Foundation → 투사체 매핑 시스템
- `04-levelup-wildcards.md`: 레벨업 선택지 + 야생카드 상세
- `06-debate-log.md`: 적 약점/내성 시스템 합의 과정
